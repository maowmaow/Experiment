<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
{% load staticfiles %}
{% load humanize %}
<title>Stock trading game - Admin view</title>
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" media="all" />

<script src="{% static 'js/jquery-2.1.0.min.js' %}"></script>
<script src="{% static 'js/angular.min.js' %}"></script>
<script src="{% static 'js/angular-cookies.min.js' %}"></script>
<script src="{% static 'js/angular-resource.min.js' %}"></script>
<script src="{% static 'stock/js/app-stock.js' %}"></script>
</head>
<body ng-app="stockApp">
<section class="container" ng-controller="gameController">
	<h1>Welcome to Stock Trading game!</h1>
	{% verbatim %}
	<div class="alert alert-info"><span ng-if="game_list.length==0">There is no active game session right now.</span> <a href="{{game_url}}/create" class="btn btn-default">Create New Game</a></div>
	<div class="panel" ng-class="game.style" ng-repeat="game in game_list track by game.pk">
		<div class="panel-heading">
			<button class="btn btn-default pull-right" type="button" ng-click="openMarketBoard(game)">Open Market Board</button>
			<h4>Game Settings: {{game.name}} <small><a href="{{game_url}}/{{game.pk}}/edit" ng-if="game.state==GAME_READY">Edit</a></small></h4>
		</div>
		<div class="panel-body form-horizontal">
			<div class="col-md-3">
				<h4>Session Settings</h4>
				<div class="form-group">
					<label class="col-sm-7 control-label">Session Password</label>
					<div class="col-sm-5"><p class="form-control-static">{{game.password}}</p></div>
				</div>
				<div class="form-group">
					<label class="col-sm-7 control-label">Session length</label>
					<div class="col-sm-5"><p class="form-control-static">{{game.period|number}} mins.</p></div>
				</div>
			</div>
			<div class="col-md-3">
				<h4>User Settings</h4>
				<div class="form-group">
					<label class="col-sm-7 control-label">Initial Cash</label>
					<div class="col-sm-5"><p class="form-control-static">{{game.init_cash|currency}}</p></div>
				</div>
				<div class="form-group">
					<label class="col-sm-7 control-label">Total User</label>
					<div class="col-sm-5"><p class="form-control-static">{{game.portfolio_count|number}}</p></div>
				</div>
			</div>
			<div class="col-md-3">
				<h4>Stock Settings (A-J)</h4>
				<div class="form-group">
					<label class="col-sm-7 control-label">Initial Price</label>
					<div class="col-sm-5"><p class="form-control-static">{{game.init_price|currency}}</p></div>
				</div>
				<div class="form-group">
					<label class="col-sm-7 control-label">Initial QTY</label>
					<div class="col-sm-5"><p class="form-control-static">{{game.init_qty|number}}</p></div>
				</div>
			</div>
			<div class="col-md-3 text-right">
				<p ng-if="game.state==GAME_READY"><button type="button" ng-click="startGame(game)" class="btn btn-lg btn-primary">Start Game</button></p>
				<p ng-if="game.state==GAME_RUNNING">Started on {{game.start|date:'h:mm:ss a'}}</p>
				<p ng-if="game.state==GAME_RUNNING"><button type="button" ng-click="stopGame(game)" class="btn btn-lg btn-danger">End Game</button></p>
				<p ng-if="game.state==GAME_END"><span class="label label-danger">Game Ended</span></p>
			</div>
		</div>
	</div>
	{% endverbatim %}
</section>
<footer>
	
</footer>
<script>
stockApp.controller('gameController', ['$scope', '$window', '$interval', 'gameSvc', function($scope, $window, $interval, gameSvc) {
	
	$scope.poll_rate = 2000;
	
	$scope.market_url = '{% url "stock:market_base" %}';
	$scope.game_url = '{% url "stock:admin_game_list" %}';
	$scope.GAME_READY = {{READY}};
	$scope.GAME_RUNNING = {{RUNNING}};
	$scope.GAME_END = {{END}};
	
	$scope.game_list = [];
	
	$scope.loadGame = function() {
		gameSvc.query(null, function(value) {
			$scope.game_list = value;
			
			angular.forEach($scope.game_list, function(game) {
				switch (game.state) {
				case {{READY}}:
					game.style = 'panel-default'; 
				break;
				case {{RUNNING}}:
					game.style = 'panel-success';
				break;
				case {{END}}:
					game.style = 'panel-danger'; 
				break;
				}
			});
		});
	};
	
	$scope.startGame = function(game) {
		gameSvc.save({game_pk:game.pk, action:'start'}, null, function(value) {
			$scope.loadGame();
			$scope.openMarketBoard(game);
		});
	};
	
	$scope.stopGame = function(game) {
		gameSvc.save({game_pk:game.pk, action:'end'}, null, function(value) {
			$scope.loadGame();
		});
	};
	
	$scope.openMarketBoard = function(game) {
		$window.open($scope.market_url + "/" + game.pk);
	};
	
	$scope.loadGame();
	
	$interval(function() {
		$scope.loadGame();	
	}, $scope.poll_rate);
	
}]);
</script>
</body>
</html>