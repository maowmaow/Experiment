<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
{% load staticfiles %}
<title>Stock trading game - Market</title>
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" media="all" />
<style>
	span.up {
		display: inline-block; width: 0; height: 0;
		border: 6px solid green;
		border-top:0;
		border-left-color: transparent;
		border-right-color: transparent;
	}
	span.down {
		display: inline-block; width: 0; height: 0;
		border: 6px solid red;
		border-bottom:0;
		border-left-color: transparent;
		border-right-color: transparent;
	}
</style>
<script src="{% static 'js/jquery-2.1.0.min.js' %}"></script>
<script src="{% static 'js/angular.min.js' %}"></script>
<script src="{% static 'js/angular-cookies.min.js' %}"></script>
<script src="{% static 'js/angular-resource.min.js' %}"></script>
<script src="{% static 'stock/js/app-stock.js' %}"></script>
</head>
<body>
<section class="container">
	<h1>Market Board</h1>
	{% verbatim %}
	<table class="table table-bordered table-condensed" ng-app="stockApp" ng-controller="marketController">
		<thead>
			<tr>
				<th>Stock Name</th>
				<th>Price</th>
				<th>Cumulative volume</th>
				<th>Bid</th>
				<th>Ask</th>
			</tr>
		</thead>
		<tbody>
			<tr ng-repeat="m in market_list track by m.pk" ng-controller="stockController">
				<td>{{m.stock}}</td>
				<td>{{m.price|currency}} <span ng-class="m.direction"></span></td>
				<td>{{m.volume_total|number}}</td>
				<td><span ng-if="m.bid>0">{{m.bid|currency}}</span><span ng-if="m.bid<=0">MP</span></td>
				<td><span ng-if="m.ask>0">{{m.ask|currency}}</span><span ng-if="m.ask<=0">MP</span></td>
			</tr>
		</tbody>
	</table>
	{% endverbatim %}
</section>
<script>
stockApp.controller('marketController', ['$scope', '$window', '$interval', 'marketSvc', function($scope, $window, $interval, marketSvc) {
	$scope.poll_rate = 400;
	
	$scope.market_list = [];

	$scope.loadData = function() {
		marketSvc.query(null, function(value) {
			for (var i=0; i<value.length; i++) {
				if ($scope.market_list[i]) {
					angular.extend($scope.market_list[i], value[i]);	
				} else {
					$scope.market_list[i] = value[i];
				}
			}
		}, function(httpResponse) {
			$scope.error = httpResponse.data;
		});
	};
	
	$interval(function() { $scope.loadData(); }, $scope.poll_rate);
}]);
stockApp.controller('stockController', ['$scope', function($scope) {
	
	$scope.$watch('m.price', function(newValue, oldValue) {
		var newV = Number(newValue);
		var oldV = Number(oldValue);
		
		if (newV > oldV) {
			$scope.m.direction = "up";
		} else if (newV < oldV) {
			$scope.m.direction = "down";
		} else {
			$scope.m.direction = "";
		}
	});
	
}]);
</script>
</body>
</html>