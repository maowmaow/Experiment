<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
{% load staticfiles %}
<title>Ultimatum game - Client view</title>
<link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" media="all" />

<script src="{% static 'js/jquery-2.1.0.min.js' %}"></script>
<script src="{% static 'js/angular.js' %}"></script>
<script src="{% static 'js/angular-cookies.js' %}"></script>
<script src="{% static 'js/angular-resource.js' %}"></script>
</head>
<body ng-app="maowmaowApp">
{% verbatim %}
<section class="container" ng-controller="utClientController">
	<h1>Welcome, {{name}}</h1>
	<h2>Please join one of these rooms</h2>
	<div class="list-group">
		<a href="javascript:void(0)" class="list-group-item" ng-repeat="r in room_list" ng-cloak>
			<h4 class="list-group-item-heading">{{r.name}}
				<button ng-hide="{{r.bidder_alias.length > 0}}" type="button" class="btn btn-default btn-xs" ng-click="joinRoom(r, 'bidder')">Join as Bidder</button>
				<button ng-show="{{r.bidder_alias.length > 0}}" type="button" class="btn btn-default btn-xs">Bidder: {{r.bidder_alias}}</button>
				
				<button ng-hide="{{r.receiver_alias.length > 0}}" type="button" class="btn btn-default btn-xs" ng-click="joinRoom(r, 'receiver')">Join as Receiver</button>
				<button ng-show="{{r.receiver_alias.length > 0}}" type="button" class="btn btn-default btn-xs">Receiver: {{r.receiver_alias}}</button>
			</h4>
		</a>
	</div>
</section>
{% endverbatim %}
<footer>
	
</footer>
<script>
	var maowmaowApp = angular.module('maowmaowApp', ['ngCookies','ngResource']);
	
	maowmaowApp.config(function($httpProvider) {
		$httpProvider.defaults.headers.common['X-Requested-With'] = 'XMLHttpRequest';
	});
	
	maowmaowApp.run(function($http, $cookies) {
		$http.defaults.headers.post['X-CSRFToken'] = $cookies['csrftoken'];
		$http.defaults.headers.delete = { 'X-CSRFToken' : $cookies['csrftoken'] };
	});
	
	maowmaowApp.factory('ultimatumSvc', ['$resource', function($resource) {
		return $resource('{% url "ultimatum:api" %}/:pk/:action');
	}]);
	
	maowmaowApp.controller('utClientController', ['$scope', '$http', '$window', 'ultimatumSvc', function($scope, $http, $window, ultimatumSvc) {
		
		$scope.name = '{{name}}';
		
		$scope.loadRoom = function(pageNo) {
			$scope.room_list = ultimatumSvc.query();
		};

		$scope.joinRoom = function(room, role) {
			ultimatumSvc.save({pk:room.pk, action:'join', 'role':role}, null, function(value) {
				$window.location.href = value.url;
			});
		};

		$scope.loadRoom();		
	}]);
</script>
</body>
</html>